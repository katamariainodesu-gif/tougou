<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>予約カレンダー</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      color: #222;
      max-width: 800px;
      margin: auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 12px;
      color: #0f172a;
      font-weight: 700;
      font-size: 24px;
    }
    #month-navigation {
      text-align: center;
      margin-bottom: 16px;
      user-select: none;
    }
    button.nav-btn {
      background-color: #0c4a6e;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      margin: 0 12px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button.nav-btn:disabled {
      background-color: #94a3b8;
      cursor: not-allowed;
    }
    button.nav-btn:hover:not(:disabled) {
      background-color: #063e5e;
    }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      user-select: none;
    }
    .day-name, .day {
      text-align: center;
      padding: 6px 0;
      font-weight: 600;
    }
    .day-name {
      background-color: #0c4a6e;
      color: white;
      border-radius: 4px;
      font-size: 14px;
    }
    .day {
      background-color: #f9fbfd;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-size: 16px;
      line-height: 28px;
    }
    .day:hover {
      background-color: #e0f2fe;
    }
    .day.inactive {
      color: #a0a8b8;
      cursor: default;
      background: none;
    }
    .day.selected {
      background-color: #22c55e;
      color: white;
      font-weight: 700;
    }

    #times-list {
      margin-top: 24px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 12px 24px rgba(0,0,0,0.08);
      padding: 16px;
      user-select: none;
    }
    #times-list h2 {
      text-align: center;
      margin-bottom: 16px;
      color: #0f172a;
      font-weight: 700;
      font-size: 20px;
    }
    .time-slot {
      display: inline-block;
      margin: 6px 6px 6px 0;
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: 700;
      cursor: pointer;
      border: 2px solid #22c55e;
      background-color: #dcfce7;
      color: #166534;
      box-shadow: inset 0 0 8px #bbf7d0;
      user-select: none;
      transition: background-color 0.3s ease;
      min-width: 72px;
      text-align: center;
    }
    .time-slot:hover {
      background-color: #a7f3d0;
    }
    .time-slot.unavailable {
      background-color: #e2e8f0;
      color: #64748b;
      border-color: #cbd5e1;
      cursor: default;
      box-shadow: none;
    }
    .time-slot.selected {
      background-color: #16a34a;
      border-color: #15803d;
      color: white;
      box-shadow: none;
    }
    #selected-info {
      margin-top: 20px;
      font-weight: 700;
      font-size: 16px;
      text-align: center;
      color: #166534;
    }
    #send-button {
      display: block;
      margin: 20px auto 0 auto;
      padding: 12px 24px;
      font-size: 16px;
      background-color: #22c55e;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #send-button:disabled {
      background-color: #a7f3d0;
      cursor: not-allowed;
    }
    #send-button:hover:not(:disabled) {
      background-color: #16a34a;
    }
  </style>
</head>
<body>
  <h1>予約したい日時を選択してください</h1>
  <div id="month-navigation">
    <button class="nav-btn" id="prev-month-btn">← 前の月</button>
    <span id="current-month-label"></span>
    <button class="nav-btn" id="next-month-btn">次の月 →</button>
  </div>
  <div id="calendar"></div>

  <div id="times-list" style="display:none;">
    <h2 id="selected-date-title"></h2>
    <div id="time-slots-container"></div>
  </div>

  <div id="selected-info">カレンダーを開き、時間を選択してください</div>
  <button id="send-button" disabled>予約を送信する</button>

<script>
const webhookUrl = "https://hook.eu2.make.com/m8ax699q4dk75uo84j5nrtu3zfm1x1pj";
const params = new URLSearchParams(window.location.search);
const userId = params.get("userId");
const duration = parseInt(params.get("duration"), 10) || 30;

// 予約データと営業時間
let reservedSlots = [];
let startHour = 8, startMinute = 0, endHour = 17, endMinute = 0;

// 選択時間（グローバル）
let selectedStart = null;
let selectedEnd = null;

function getTodayJST() {
  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset() * 60000;
  return new Date(utc + 9 * 3600000);
}

const today = getTodayJST();
let displayedYear = today.getFullYear();
let displayedMonth = today.getMonth();

const minMonth = displayedMonth;
const minYear = displayedYear;

let maxDate = new Date(displayedYear, displayedMonth + 2, 1);
const maxYear = maxDate.getFullYear();
const maxMonth = maxDate.getMonth();

const calendar = document.getElementById("calendar");
const currentMonthLabel = document.getElementById("current-month-label");
const prevBtn = document.getElementById("prev-month-btn");
const nextBtn = document.getElementById("next-month-btn");

let selectedDayDiv = null;

function updateMonthLabel(year, month) {
  currentMonthLabel.textContent = `${year}年${month + 1}月`;
}

function canGoPrev() {
  if(displayedYear < minYear) return false;
  if(displayedYear === minYear && displayedMonth <= minMonth) return false;
  return true;
}
function canGoNext() {
  if(displayedYear > maxYear) return false;
  if(displayedYear === maxYear && displayedMonth >= maxMonth) return false;
  return true;
}

function setNavButtons() {
  prevBtn.disabled = !canGoPrev();
  nextBtn.disabled = !canGoNext();
}

function buildCalendar(year, month) {
  calendar.innerHTML = "";

  const dayNames = ["日","月","火","水","木","金","土"];
  dayNames.forEach(dn => {
    const dnElem = document.createElement("div");
    dnElem.className = "day-name";
    dnElem.textContent = dn;
    calendar.appendChild(dnElem);
  });

  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const firstWeekDay = firstDay.getDay();
  const daysInMonth = lastDay.getDate();

  for(let i=0; i < firstWeekDay; i++){
    const emptyDiv = document.createElement("div");
    emptyDiv.className = "day inactive";
    calendar.appendChild(emptyDiv);
  }

  for(let d=1; d <= daysInMonth; d++){
    const dayDiv = document.createElement("div");
    dayDiv.className = "day";

    const dayDate = new Date(year, month, d);
    const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    if(dayDate < todayDateOnly){
      dayDiv.classList.add("inactive");
    }

    dayDiv.textContent = d;
    dayDiv.dataset.date = `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    dayDiv.addEventListener("click", () => onDateSelected(dayDiv));
    calendar.appendChild(dayDiv);
  }

  updateMonthLabel(year, month);
  setNavButtons();

  if(selectedDayDiv){
    selectedDayDiv.classList.remove("selected");
    selectedDayDiv = null;
  }
  document.getElementById("times-list").style.display = "none";
  document.getElementById("selected-info").textContent = "予約したい日時を選択してください。";
  document.getElementById("send-button").disabled = true;
  selectedStart = null;
  selectedEnd = null;
}

function onDateSelected(dayDiv){
  if(dayDiv.classList.contains("inactive")) return;

  if(selectedDayDiv) selectedDayDiv.classList.remove("selected");
  dayDiv.classList.add("selected");
  selectedDayDiv = dayDiv;

  showTimeSlotsForDate(dayDiv.dataset.date);
}

function showTimeSlotsForDate(dateStr){
  const container = document.getElementById("times-list");
  const slotsContainer = document.getElementById("time-slots-container");
  const title = document.getElementById("selected-date-title");

  title.textContent = `${dateStr} の予約可能時間`;
  container.style.display = "block";
  slotsContainer.innerHTML = "";

  const baseDate = new Date(dateStr + "T00:00:00+09:00");
  let current = new Date(baseDate);
  current.setHours(startHour, startMinute, 0, 0);
  const end = new Date(baseDate);
  end.setHours(endHour, endMinute, 0, 0);

  const reservedForDay = reservedSlots.filter(slot => {
    const slotStart = new Date(slot.start);
    return slotStart.toISOString().slice(0,10) === dateStr;
  });

  const timeSlots = [];
  while(current < end){
    const slotEnd = new Date(current.getTime() + duration*60000);
    const isReserved = reservedForDay.some(slot=>{
      const s = new Date(slot.start);
      const e = new Date(slot.end);
      return !(slotEnd <= s || current >= e);
    });
    timeSlots.push({ time: current, reserved: isReserved });
    current = new Date(current.getTime() + 30*60000);
  }

  let selectedTimeDiv = null;
  const sendBtn = document.getElementById("send-button");
  sendBtn.disabled = true;
  selectedStart = null;
  selectedEnd = null;

  timeSlots.forEach(slot=>{
    const timeDiv = document.createElement("div");
    timeDiv.className = "time-slot";
    if(slot.reserved) timeDiv.classList.add("unavailable");

    const hh = String(slot.time.getHours()).padStart(2,"0");
    const mm = String(slot.time.getMinutes()).padStart(2,"0");
    timeDiv.textContent = `${hh}:${mm}`;

    if(!slot.reserved){
      timeDiv.addEventListener("click", ()=>{
        if(selectedTimeDiv) selectedTimeDiv.classList.remove("selected");
        timeDiv.classList.add("selected");
        selectedTimeDiv = timeDiv;

        selectedStart = slot.time;
        selectedEnd = new Date(selectedStart.getTime() + duration*60000);

        document.getElementById("selected-info").textContent = `選択中: ${dateStr} ${timeDiv.textContent}`;
        sendBtn.disabled = false;
      });
    }

    slotsContainer.appendChild(timeDiv);
  });

  sendBtn.onclick = async ()=>{
    if(!userId) { alert("ユーザーIDが無効です。"); return; }
    if(!selectedStart || !selectedEnd){ alert("時間を選択してください"); return; }

    try{
      const res = await fetch(webhookUrl,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
          userId: userId,
          message: "確定予約",
          start: selectedStart.toISOString(),
          end: selectedEnd.toISOString()
        })
      });
      if(!res.ok) throw new Error("送信に失敗しました");
      alert(`予約日時を送信しました！\n${dateStr} ${String(selectedStart.getHours()).padStart(2,"0")}:${String(selectedStart.getMinutes()).padStart(2,"0")} ～ ${String(selectedEnd.getHours()).padStart(2,"0")}:${String(selectedEnd.getMinutes()).padStart(2,"0")}`);
      
      if(selectedTimeDiv) selectedTimeDiv.classList.remove("selected");
      selectedTimeDiv = null;
      selectedStart = null;
      selectedEnd = null;
      document.getElementById("selected-info").textContent = "予約したい日時を選択してください。";
      sendBtn.disabled = true;
    }catch(err){
      alert(`エラーが発生しました: ${err.message}`);
    }
  };
}

prevBtn.addEventListener("click", ()=>{
  if(displayedMonth === minMonth && displayedYear === minYear) return;
  if(displayedMonth === 0){
    displayedMonth = 11;
    displayedYear--;
  } else {
    displayedMonth--;
  }
  buildCalendar(displayedYear, displayedMonth);
});

nextBtn.addEventListener("click", ()=>{
  if(displayedMonth === maxMonth && displayedYear === maxYear) return;
  if(displayedMonth === 11){
    displayedMonth = 0;
    displayedYear++;
  } else {
    displayedMonth++;
  }
  buildCalendar(displayedYear, displayedMonth);
});

async function initialize(){
  if(!userId){
    alert("URLにuserIdパラメータがありません。");
    return;
  }
  try{
    const res = await fetch(`${webhookUrl}?userId=${encodeURIComponent(userId)}&duration=${encodeURIComponent(duration)}`);
    if(!res.ok) throw new Error("予約データ取得に失敗しました");
    const data = await res.json();

    if(data.length>0){
      const first = data[0];
      startHour = parseInt(first["開始時間"],10);
      startMinute = parseInt(first["開始分"],10);
      endHour = parseInt(first["終了時間"],10);
      endMinute = parseInt(first["終了分"],10);

      reservedSlots = data.map(d=>({start:d.start, end:d.end}));
    }

    buildCalendar(displayedYear, displayedMonth);
  }catch(err){
    alert(err.message);
  }
}

initialize();

</script>

</body>
</html>

